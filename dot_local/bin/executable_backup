#!/bin/sh

# A simple script to easily backup and restore

MOUNT=/mnt/
SOURCES=(
	# "Music"
	# "Pictures"
	"Documents"
	# "Videos"
	# "Downloads/ISO"
	# ".local/share/sioyek"
)
LOCAL_ISMOUNTED=$(mount | grep sdb)
CLOUD_MOUNT=sync_g_drive:
CLOUD_ISMOUNTED=$(rclone listremotes | grep $CLOUD_MOUNT)

local_sync() {
	for SOURCE in "${SOURCES[@]}"; do
		# Re configured files to delete as well
    # -a = archive mode
    # -u = skip files that are newer on the receiver
    # -A = preserve ACLs
    # -X = preserve extended attributes
    # -v = print the version + other info and exit
    # -P = Progress bar
		# rsync -auAXvP "$FROM$SOURCE" "$TO"
    # rclone copy -PL "$FROM$SOURCE" "$TO$SOURCE"
   rclone sync -PL --fast-list "$FROM$SOURCE" "$TO$SOURCE/" --backup-dir "$TO/backup/$(date -I)/$SOURCE/"
	done

}

cloud_sync(){
	for SOURCE in "${SOURCES[@]}"; do
   rclone sync -PL --fast-list "$FROM$SOURCE" "$TO$SOURCE/" --backup-dir "$TO/backup/$(date -I)/$SOURCE/"
  done
}

local_run() {

	if [ "$LOCAL_ISMOUNTED" != '' ]; then
		local_sync
	else
		echo "Drive is not mounted"
	fi
}

cloud_run() {

	if [ "$CLOUD_ISMOUNTED" != '' ]; then
		cloud_sync
	else
		echo "Drive is not mounted"
	fi
}

secret_restore(){
	cp -r /mnt/Important/. ~/
	chown -R $(whoami) ~/.gnupg/
	sudo chmod 700 ~/.ssh
	sudo chmod 600 ~/.ssh/id_rsa
	find ~/.gnupg -type f -exec chmod 600 {} \;
	find ~/.gnupg -type d -exec chmod 700 {} \;
	git clone git@github.com:mkadit/pass.git ~/.password-store

}

if [ "$1" = 'local_restore' ]; then

	FROM="$MOUNT"
	TO="$HOME/"
	echo "Restoring data"
    local_run
elif [ "$1" = 'local_backup' ]; then

	FROM="$HOME/"
	TO="$MOUNT"
	echo "Backuping data"
    local_run
elif [ "$1" = 'cloud_restore' ]; then

	FROM="$CLOUD_MOUNT"
	TO="$HOME/"
	echo "Restoring data"
    cloud_run
elif [ "$1" = 'cloud_backup' ]; then

	FROM="$HOME/"
	TO="$CLOUD_MOUNT"
	echo "Backuping data"
    cloud_run
elif [ "$1" = 'secret_restore' ]; then
	secret_restore
else
	echo "Command is incorrect"
fi
